{"ignition":{"version":"2.0.0","config":{}},"storage":{"files":[{"filesystem":"root","path":"/etc/docker/certs.d/flowercluster:5000/domain.crt","contents":{"source":"data:,-----BEGIN%20CERTIFICATE-----%0AMIIDAzCCAeugAwIBAgIJALW8aEgy1RciMA0GCSqGSIb3DQEBCwUAMBgxFjAUBgNV%0ABAMMDWZsb3dlcmNsdXN0ZXIwHhcNMTYxMDMxMTYyMjQ4WhcNMTcxMDMxMTYyMjQ4%0AWjAYMRYwFAYDVQQDDA1mbG93ZXJjbHVzdGVyMIIBIjANBgkqhkiG9w0BAQEFAAOC%0AAQ8AMIIBCgKCAQEAnxS0E95pnzmSOoKxdDqZ5FVniFmuKVy7Oaz2Ecl3FLcvbfx7%0AmqoI9F0lsuaSdIaDT87tcDgXDA91blyiSSbe%2BRPG%2FHmlb7lQvXRIh5SwtwLoDcLP%0Ao9UFCNzO%2FSjoNLnntqt3bGpT6qRzMYKu3tkzByyQXPbUQ4dO9D2q%2Bb3SYDpPRY0u%0ASrme7HQA798LkSLHO0ENHXwW9BG1dL4SZOKnEwCk%2Bj4egVRQLfLRIezRqcSzdCLL%0AbLSs7L0ApDjwZLk8JtpH5NLSyy%2BwPm%2B55990%2F9vkNhCUIcdXOtl5OFlOh3XZKM3r%0A9IlpTwM7qFFz7SgM9BcxI2HvSsMGLdwg0WLPjwIDAQABo1AwTjAdBgNVHQ4EFgQU%0AvFN43MvmkOT6zINC%2FcsATv9KLaMwHwYDVR0jBBgwFoAUvFN43MvmkOT6zINC%2FcsA%0ATv9KLaMwDAYDVR0TBAUwAwEB%2FzANBgkqhkiG9w0BAQsFAAOCAQEAKWAl0bd0%2Bcrl%0AAidD8VSg%2BhxJcEZT3IKJ8PxlureUzPGxm%2Btk3k%2B%2Bg2To%2FskrW4KHcJ3HAgK6Bll7%0AuPCbUphJfJKVUe37zJSKIbGrDUboSkTbab7p3fIpehq0NkfHKjkmOX35rtvaNOl9%0ARupX9EsSwNUqReVMDC6cwQEIfFX%2BvStfN4TgAacM4OkSZ7iZxaRbHUYxSFtkyPJw%0AU0yoCSwFJdBqa6OFJ2ZCdUvhSEO1ug8ERgd2cLx1GeIdIBKX4mZGW%2BpyRhI6qM5k%0A6%2FWxI6TLp5gixicV8q%2BK6D642ioKXzbxMQWSLq9KmDIocjsnMybP1%2F7hwKUZxiEZ%0AQ70T7pP0zQ%3D%3D%0A-----END%20CERTIFICATE-----%0A","verification":{}},"mode":420,"user":{},"group":{}},{"filesystem":"root","path":"/opt/bin/habitus","contents":{"source":"https://github.com/cloud66/habitus/releases/download/v0.4.7/habitus_linux_amd64","verification":{"hash":"sha512-9d7ed3f2312b3e8ae1c53bd6b73eb88c21f8f4b94b96c0b55823fb25906a757899b116f872cd1b29dba824621be25e88616c31f4723b255abb1824c2f8d0e3e8"}},"mode":493,"user":{},"group":{}},{"filesystem":"root","path":"/opt/bin/docker-compose","contents":{"source":"https://github.com/docker/compose/releases/download/1.8.0/docker-compose-Linux-x86_64","verification":{"hash":"sha512-b608b8c20d30e344797a5e5ab06e4ba4f3358a84b039924b09757cc04a96352d3cf0f360c239925ac5144bf9017c81c19f4ebe100bb75824698fc16b335cd9db"}},"mode":493,"user":{},"group":{}},{"filesystem":"root","path":"/opt/vault.zip","contents":{"source":"https://releases.hashicorp.com/vault/0.6.2/vault_0.6.2_linux_amd64.zip","verification":{"hash":"sha512-5a37ad553d38849a5a91568ce03d23abf668850049b3d550a5309a1acc391347156d09e08c8115599654c19a7c67856aa6776ac939a34440a095eb35cc47de37"}},"mode":420,"user":{},"group":{}}]},"systemd":{"units":[{"name":"sshd.socket","enable":true,"contents":"[Unit]\nDescription=OpenSSH Server Socket\nConflicts=sshd.service\n\n[Socket]\nListenStream=2222\nFreeBind=true\nReusePort=true\nAccept=yes\n\n[Install]\nWantedBy=sockets.target\n"},{"name":"unzip-vault.service","enable":true,"contents":"[Unit]\nConditionFirstBoot=yes\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/unzip /opt/vault.zip -d /opt/bin/\n\n[Install]\nWantedBy=multi-user.target\n"},{"name":"format-flowercluster-docker.service","enable":true,"contents":"[Unit]\nDescription=Formats the docker persistent drive\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStart=/usr/bin/bash -c 'if [ \"$(blkid -s TYPE -o value /dev/disk/by-id/google-flowercluster-docker)\" != \"ext4\" ]; then /usr/sbin/mkfs.ext4 /dev/disk/by-id/google-flowercluster-docker; fi'\n"},{"name":"var-lib-docker.mount","enable":true,"contents":"[Unit]\nDescription=mount persistent drive to /var/lib/docker\nAfter=format-flowercluster-docker.service\nRequires=format-flowercluster-docker.service\n\n[Mount]\nWhat=/dev/disk/by-id/google-flowercluster-docker\nWhere=/var/lib/docker\nType=ext4\n"},{"name":"clone-flowercluster.service","enable":true,"contents":"[Unit]\nDescription=Fetches flowercluster repository\nWants=vault.service\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nConditionPathExists=!/opt/flowercluster\nExecStart=/usr/bin/git clone -b vault https://github.com/djanatyn/flowercluster.git /opt/flowercluster\n"},{"name":"vault.service","enable":true,"contents":"[Unit]\nDescription=hashicorp vault\nAfter=docker.service\n\n[Service]\nWorkingDirectory=/opt/flowercluster/docker/vault\nType=oneshot\nRemainAfterExit=yes\nExecStop=/opt/bin/docker-compose stop\nExecStart=/opt/bin/docker-compose up -d\n"},{"name":"docker.service","enable":true,"dropins":[{"name":"10-wait-docker.conf","contents":"[Unit]\nAfter=var-lib-docker.mount\nRequires=var-lib-docker.mount\nRequires=clone-flowercluster.service\nWants=registry.service\nWants=gogs.service\nWants=development.service\n"}]},{"name":"registry.service","enable":true,"contents":"[Unit]\nDescription=Registry\nAfter=vault.service\n\n[Service]\nRestartSec=10s\nRestart=on-failure\nExecStartPre=-/usr/bin/docker kill registry1\nExecStartPre=-/usr/bin/docker rm registry1\nExecStart=/usr/bin/docker run -p 5000:5000 -v registry-data:/var/lib/registry -v registry-certs:/certs -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key --name registry1 registry:2\nExecStop=/usr/bin/docker stop -t 2 registry1\n"},{"name":"gogs.service","enable":true,"contents":"[Unit]\nDescription=gogs\nAfter=docker.service\n\n[Service]\nRestartSec=10s\nRestart=on-failure\nExecStartPre=-/usr/bin/docker kill gogs1\nExecStartPre=-/usr/bin/docker rm gogs1\nExecStart=/usr/bin/docker run --name gogs1 -p 3000:3000 -p 3001:22 -v gogs-data:/data flowercluster:5000/flowercluster-gogs\nExecStop=/usr/bin/docker stop -t 2 gogs\n"},{"name":"development.service","enable":true,"contents":"[Unit]\nAfter=docker.service\n\n[Service]\nRestartSec=10s\nRestart=on-failure\nExecStartPre=-/usr/bin/docker kill development1\nExecStartPre=-/usr/bin/docker rm development1\nExecStart=/usr/bin/docker run --name development1 -v home-data:/home -p 2222:22 flowercluster:5000/development\nExecStop=/usr/bin/docker stop -t 2 development1\n"},{"name":"haproxy.service","enable":true,"contents":"[Unit]\nDescription=HAProxy\nAfter=docker.service\n\n[Service]\nTimeoutStartSec=0\nExecStartPre=-/usr/bin/docker kill haproxy1\nExecStartPre=-/usr/bin/docker rm haproxy1\nExecStartPre=/usr/bin/docker run --net host --name haproxy1 flowercluster:5000/haproxy\nExecStart=/usr/bin/docker start haproxy1\nExecStop=/usr/bin/docker stop haproxy1\n"}]},"networkd":{},"passwd":{}}