{"ignition":{"version":"2.0.0","config":{}},"storage":{"files":[{"filesystem":"root","path":"/opt/bin/habitus","contents":{"source":"https://github.com/cloud66/habitus/releases/download/v0.4.7/habitus_linux_amd64","verification":{"hash":"sha512-9d7ed3f2312b3e8ae1c53bd6b73eb88c21f8f4b94b96c0b55823fb25906a757899b116f872cd1b29dba824621be25e88616c31f4723b255abb1824c2f8d0e3e8"}},"mode":493,"user":{},"group":{}},{"filesystem":"root","path":"/opt/bin/docker-compose","contents":{"source":"https://github.com/docker/compose/releases/download/1.8.0/docker-compose-Linux-x86_64","verification":{"hash":"sha512-b608b8c20d30e344797a5e5ab06e4ba4f3358a84b039924b09757cc04a96352d3cf0f360c239925ac5144bf9017c81c19f4ebe100bb75824698fc16b335cd9db"}},"mode":493,"user":{},"group":{}},{"filesystem":"root","path":"/opt/vault.zip","contents":{"source":"https://releases.hashicorp.com/vault/0.6.2/vault_0.6.2_linux_amd64.zip","verification":{"hash":"sha512-5a37ad553d38849a5a91568ce03d23abf668850049b3d550a5309a1acc391347156d09e08c8115599654c19a7c67856aa6776ac939a34440a095eb35cc47de37"}},"mode":420,"user":{},"group":{}}]},"systemd":{"units":[{"name":"sshd.socket","enable":true,"contents":"[Unit]\nDescription=OpenSSH Server Socket\nConflicts=sshd.service\n\n[Socket]\nListenStream=2222\nFreeBind=true\nReusePort=true\nAccept=yes\n\n[Install]\nWantedBy=sockets.target\n"},{"name":"unzip-vault.service","enable":true,"contents":"[Unit]\nConditionFirstBoot=yes\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/unzip /opt/vault.zip -d /opt/bin/\n\n[Install]\nWantedBy=multi-user.target\n"},{"name":"format-flowercluster-docker.service","enable":true,"contents":"[Unit]\nDescription=Formats the docker persistent drive\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStart=/usr/bin/bash -c 'if [ \"$(blkid -s TYPE -o value /dev/disk/by-id/google-flowercluster-docker)\" != \"ext4\" ]; then /usr/sbin/mkfs.ext4 /dev/disk/by-id/google-flowercluster-docker; fi'\n"},{"name":"var-lib-docker.mount","enable":true,"contents":"[Unit]\nDescription=mount persistent drive to /var/lib/docker\nAfter=format-flowercluster-docker.service\nRequires=format-flowercluster-docker.service\n\n[Mount]\nWhat=/dev/disk/by-id/google-flowercluster-docker\nWhere=/var/lib/docker\nType=ext4\n"},{"name":"clone-flowercluster.service","enable":true,"contents":"[Unit]\nDescription=Fetches flowercluster repository\nWants=vault.service\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nConditionPathExists=!/opt/flowercluster\nExecStart=/usr/bin/git clone -b vault https://github.com/djanatyn/flowercluster.git /opt/flowercluster\n"},{"name":"vault.service","enable":true,"contents":"[Unit]\nDescription=hashicorp vault\nAfter=docker.service\n\n[Service]\nWorkingDirectory=/opt/flowercluster/docker/vault\nType=oneshot\nRemainAfterExit=yes\nExecStop=/opt/bin/docker-compose stop\nExecStart=/opt/bin/docker-compose up -d\n"},{"name":"docker.service","enable":true,"dropins":[{"name":"10-wait-docker.conf","contents":"[Unit]\nAfter=var-lib-docker.mount\nRequires=var-lib-docker.mount\nRequires=clone-flowercluster.service\nWants=gogs.service\nWants=development.service\n"}]},{"name":"gogs.service","enable":true,"contents":"[Unit]\nDescription=gogs\nAfter=docker.service\n\n[Service]\nRestartSec=10s\nRestart=on-failure\nExecStartPre=-/usr/bin/docker kill gogs1\nExecStartPre=-/usr/bin/docker rm gogs1\nExecStart=/usr/bin/docker run --name gogs1 -p 3000:3000 -p 3001:22 -v gogs-data:/data flowercluster:5000/flowercluster-gogs\nExecStop=/usr/bin/docker stop -t 2 gogs\n"},{"name":"development.service","enable":true,"contents":"[Unit]\nAfter=docker.service\n\n[Service]\nRestartSec=10s\nRestart=on-failure\nExecStartPre=-/usr/bin/docker kill development1\nExecStartPre=-/usr/bin/docker rm development1\nExecStart=/usr/bin/docker run --name development1 -v home-data:/home -p 2222:22 flowercluster:5000/development\nExecStop=/usr/bin/docker stop -t 2 development1\n"},{"name":"haproxy.service","enable":true,"contents":"[Unit]\nDescription=HAProxy\nAfter=docker.service\n\n[Service]\nTimeoutStartSec=0\nExecStartPre=-/usr/bin/docker kill haproxy1\nExecStartPre=-/usr/bin/docker rm haproxy1\nExecStartPre=/usr/bin/docker run --net host --name haproxy1 flowercluster:5000/haproxy\nExecStart=/usr/bin/docker start haproxy1\nExecStop=/usr/bin/docker stop haproxy1\n"}]},"networkd":{},"passwd":{}}