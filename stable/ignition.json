{"ignition":{"version":"2.0.0","config":{}},"storage":{"files":[{"filesystem":"root","path":"/etc/docker/certs.d/stable:5000/domain.crt","contents":{"source":"data:,-----BEGIN%20CERTIFICATE-----%0AMIIC9TCCAd2gAwIBAgIJAMxqwLP3h2pQMA0GCSqGSIb3DQEBCwUAMBExDzANBgNV%0ABAMMBnN0YWJsZTAeFw0xNjA4MjQxNzUyMjJaFw0xNzA4MjQxNzUyMjJaMBExDzAN%0ABgNVBAMMBnN0YWJsZTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMTU%0AIr19HetCT5C%2BuX%2BqJnw3InBIMk05uJJTeBWWVBTvvVKmEtrwtRtGts0ue4dYQhpm%0A72gy3zerg8%2FGQM3QGuNfkVtdtcNhp7kHFT7sAjv%2BC2%2FZnEl0oBkT2VoRCePT6ydu%0AkMXVMaA7lpZAIcKkZ13aiCG2cMrlpAg6Lo44Dy%2BvJCBoY2LnJkrgV2FpIIPLFdQ6%0AOVEkLKDWQNfIVv5ljwP5PDKs38IdYfQpnmGnd7pOp8Aao18FyiR%2BrST0wlKNY%2BFv%0AegANIwQrYJwYBQDKuASaxGHSF4DXrJidHUCcbkS2xAl5ohHM3lAl%2BLu4%2Fiq6BZLf%0AsftkP87U%2F9qMTVud35sCAwEAAaNQME4wHQYDVR0OBBYEFJxKekgur5Jjwh00BgWq%0AblLyBNfNMB8GA1UdIwQYMBaAFJxKekgur5Jjwh00BgWqblLyBNfNMAwGA1UdEwQF%0AMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAHSRLCMmHMK4SyqPweleaq5%2FFRcE2aqs%0A3Tmk7YWNRAC8V2Dly3oQrp0YBcr%2BT9AiXcMJVaPBwPTzIpfA6hsMgj2HVmzHk4xi%0A615tuGjufGQlEsYy1sUQsgUNWBk8bLTZsM4ZVEKPxnDzp5aZKV7jlFLlWhnlwS%2BC%0AmtaP0b9blrl3qE1XPts%2FeKlivtlzWGpnfbWGZngKqVj9UmdmgZH0C3y6UqeQjLAG%0AIBXI6Kf7uuUMtAGZnQH8rKs66ecpIXHLegZ9Xg3N1cgRpU62BraTqrhATWGoy8F5%0Ardkh7KPIcGQwoySbmVEhHJxiXN9TdQkxq5hEPlUbqmspWO%2FoRT%2FsMuk%3D%0A-----END%20CERTIFICATE-----%0A","verification":{}},"mode":420,"user":{},"group":{}},{"filesystem":"root","path":"/opt/bin/docker-compose","contents":{"source":"https://github.com/docker/compose/releases/download/1.8.0/docker-compose-Linux-x86_64","verification":{"hash":"sha512-b608b8c20d30e344797a5e5ab06e4ba4f3358a84b039924b09757cc04a96352d3cf0f360c239925ac5144bf9017c81c19f4ebe100bb75824698fc16b335cd9db"}},"mode":493,"user":{},"group":{}},{"filesystem":"root","path":"/tmp/vault.zip","contents":{"source":"https://releases.hashicorp.com/vault/0.6.2/vault_0.6.2_linux_amd64.zip","verification":{"hash":"sha512-5a37ad553d38849a5a91568ce03d23abf668850049b3d550a5309a1acc391347156d09e08c8115599654c19a7c67856aa6776ac939a34440a095eb35cc47de37"}},"mode":420,"user":{},"group":{}}]},"systemd":{"units":[{"name":"etcd2.service","enable":true,"dropins":[{"name":"metadata.conf","contents":"[Unit]\nRequires=coreos-metadata.service\nAfter=coreos-metadata.service\n[Service]\nEnvironmentFile=/run/metadata/coreos\nExecStart=\nExecStart=/usr/bin/etcd2 \\\n--advertise-client-urls=http://${COREOS_GCE_IP_EXTERNAL_0}:2379 \\\n--initial-advertise-peer-urls=http://${COREOS_GCE_IP_EXTERNAL_0}:2380 \\\n--listen-client-urls=http://0.0.0.0:2379 \\\n--listen-peer-urls=http://${COREOS_GCE_IP_EXTERNAL_0}:2380 \\\n--discovery=https://discovery.etcd.io/6254d174b0ca958abd15d35b98a9fd60\n"}]},{"name":"unzip-vault.service","enable":true,"contents":"[Unit]\nConditionFirstBoot=yes\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/unzip /tmp/vault.zip -d /opt/bin/\n\n[Install]\nWantedBy=multi-user.target\n"},{"name":"format-stable-docker.service","enable":true,"contents":"[Unit]\nDescription=Formats the docker persistent drive\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStart=/usr/bin/bash -c 'if [ \"$(blkid -s TYPE -o value /dev/disk/by-id/google-stable-docker)\" != \"ext4\" ]; then /usr/sbin/mkfs.ext4 /dev/disk/by-id/google-stable-docker; fi'\n"},{"name":"var-lib-docker.mount","enable":true,"contents":"[Unit]\nDescription=mount persistent drive to /var/lib/docker\nAfter=format-stable-docker.service\nRequires=format-stable-docker.service\n\n[Mount]\nWhat=/dev/disk/by-id/google-stable-docker\nWhere=/var/lib/docker\nType=ext4\n"},{"name":"clone-flowercluster.service","enable":true,"contents":"[Unit]\nDescription=Fetches flowercluster repository\nWants=vault.service\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nConditionPathExists=!/opt/flowercluster\nExecStart=/usr/bin/git clone -b vault https://github.com/djanatyn/flowercluster.git /opt/flowercluster\n"},{"name":"vault.service","enable":true,"contents":"[Unit]\nDescription=hashicorp vault\nAfter=docker.service\n\n[Service]\nWorkingDirectory=/opt/flowercluster/docker-compose/vault\nType=oneshot\nRemainAfterExit=yes\nExecStop=/opt/bin/docker-compose stop\nExecStart=/opt/bin/docker-compose up -d\n"},{"name":"docker.service","enable":true,"dropins":[{"name":"10-wait-docker.conf","contents":"[Unit]\nAfter=var-lib-docker.mount\nRequires=var-lib-docker.mount\nRequires=clone-flowercluster.service\nWants=registry.service\nWants=gogs.service\nWants=development.service\n"}]},{"name":"registry.service","enable":true,"contents":"[Unit]\nDescription=Registry\nAfter=vault.service\n\n[Service]\nRestartSec=10s\nRestart=on-failure\nExecStartPre=-/usr/bin/docker kill registry1\nExecStartPre=-/usr/bin/docker rm registry1\nExecStart=/usr/bin/docker run -p 5000:5000 -v registry-data:/var/lib/registry -v registry-certs:/certs -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key --name registry1 registry:2\nExecStop=/usr/bin/docker stop -t 2 registry1\n"},{"name":"gogs.service","enable":true,"contents":"[Unit]\nDescription=gogs\nAfter=docker.service\n\n[Service]\nRestartSec=10s\nRestart=on-failure\nExecStartPre=-/usr/bin/docker kill gogs1\nExecStartPre=-/usr/bin/docker rm gogs1\nExecStart=/usr/bin/docker run --name gogs1 -p 3000:3000 -p 3001:22 -v gogs-data:/data stable:5000/flowercluster-gogs\nExecStop=/usr/bin/docker stop -t 2 gogs\n"},{"name":"development.service","enable":true,"contents":"[Unit]\nAfter=docker.service\n\n[Service]\nRestartSec=10s\nRestart=on-failure\nExecStartPre=-/usr/bin/docker kill development1\nExecStartPre=-/usr/bin/docker rm development1\nExecStart=/usr/bin/docker run --name development1 -v home-data:/home -p 2222:22 stable:5000/development\nExecStop=/usr/bin/docker stop -t 2 development1\n"}]},"networkd":{},"passwd":{}}