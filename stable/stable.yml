---
systemd:
  units:
    - name: etcd2.service
      enable: True
      dropins:
        - name: metadata.conf
          contents: |
            [Unit]
            Requires=coreos-metadata.service
            After=coreos-metadata.service
            [Service]
            EnvironmentFile=/run/metadata/coreos
            ExecStart=
            ExecStart=/usr/bin/etcd2 \
            --advertise-client-urls=http://${COREOS_GCE_IP_EXTERNAL_0}:2379 \
            --initial-advertise-peer-urls=http://${COREOS_GCE_IP_EXTERNAL_0}:2380 \
            --listen-client-urls=http://0.0.0.0:2379 \
            --listen-peer-urls=http://${COREOS_GCE_IP_EXTERNAL_0}:2380 \
            --discovery=https://discovery.etcd.io/6254d174b0ca958abd15d35b98a9fd60
    - name: unzip-vault.service
      enable: True
      contents: |
        [Unit]
        ConditionFirstBoot=yes

        [Service]
        Type=oneshot
        ExecStart=/usr/bin/unzip /opt/vault.zip -d /opt/bin/
        
        [Install]
        WantedBy=multi-user.target
    - name: format-flowercluster-docker.service
      enable: True
      contents: |
        [Unit]
        Description=Formats the docker persistent drive
        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/bin/bash -c 'if [ "$(blkid -s TYPE -o value /dev/disk/by-id/google-flowercluster-docker)" != "ext4" ]; then /usr/sbin/mkfs.ext4 /dev/disk/by-id/google-flowercluster-docker; fi'
    - name: var-lib-docker.mount
      enable: True
      contents: |
        [Unit]
        Description=mount persistent drive to /var/lib/docker
        After=format-flowercluster-docker.service
        Requires=format-flowercluster-docker.service

        [Mount]
        What=/dev/disk/by-id/google-flowercluster-docker
        Where=/var/lib/docker
        Type=ext4
    - name: clone-flowercluster.service
      enable: True
      contents: |
        [Unit]
        Description=Fetches flowercluster repository
        Wants=vault.service

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ConditionPathExists=!/opt/flowercluster
        ExecStart=/usr/bin/git clone -b vault https://github.com/djanatyn/flowercluster.git /opt/flowercluster
    - name: vault.service
      enable: True
      contents: |
        [Unit]
        Description=hashicorp vault
        After=docker.service

        [Service]
        WorkingDirectory=/opt/flowercluster/docker-compose/vault
        Type=oneshot
        RemainAfterExit=yes
        ExecStop=/opt/bin/docker-compose stop
        ExecStart=/opt/bin/docker-compose up -d
    - name: docker.service
      enable: True
      dropins:
        - name: 10-wait-docker.conf
          contents: |
            [Unit]
            After=var-lib-docker.mount
            Requires=var-lib-docker.mount
            Requires=clone-flowercluster.service
            Wants=registry.service
            Wants=gogs.service
            Wants=development.service
    - name: registry.service
      enable: True
      contents: |
        [Unit]
        Description=Registry
        After=vault.service

        [Service]
        RestartSec=10s
        Restart=on-failure
        ExecStartPre=-/usr/bin/docker kill registry1
        ExecStartPre=-/usr/bin/docker rm registry1
        ExecStart=/usr/bin/docker run -p 5000:5000 -v registry-data:/var/lib/registry -v registry-certs:/certs -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key --name registry1 registry:2
        ExecStop=/usr/bin/docker stop -t 2 registry1
    - name: gogs.service
      enable: True
      contents: |
        [Unit]
        Description=gogs
        After=docker.service

        [Service]
        RestartSec=10s
        Restart=on-failure
        ExecStartPre=-/usr/bin/docker kill gogs1
        ExecStartPre=-/usr/bin/docker rm gogs1
        ExecStart=/usr/bin/docker run --name gogs1 -p 3000:3000 -p 3001:22 -v gogs-data:/data flowercluster:5000/flowercluster-gogs
        ExecStop=/usr/bin/docker stop -t 2 gogs
    - name: development.service
      enable: True
      contents: |
        [Unit]
        After=docker.service

        [Service]
        RestartSec=10s
        Restart=on-failure
        ExecStartPre=-/usr/bin/docker kill development1
        ExecStartPre=-/usr/bin/docker rm development1
        ExecStart=/usr/bin/docker run --name development1 -v home-data:/home -p 2222:22 flowercluster:5000/development
        ExecStop=/usr/bin/docker stop -t 2 development1
storage:
  files:
    - path: /etc/docker/certs.d/flowercluster:5000/domain.crt
      filesystem: root
      mode: 0644
      user:
        id: 0
      contents:
        inline: |
          -----BEGIN CERTIFICATE-----
          MIIDAzCCAeugAwIBAgIJALW8aEgy1RciMA0GCSqGSIb3DQEBCwUAMBgxFjAUBgNV
          BAMMDWZsb3dlcmNsdXN0ZXIwHhcNMTYxMDMxMTYyMjQ4WhcNMTcxMDMxMTYyMjQ4
          WjAYMRYwFAYDVQQDDA1mbG93ZXJjbHVzdGVyMIIBIjANBgkqhkiG9w0BAQEFAAOC
          AQ8AMIIBCgKCAQEAnxS0E95pnzmSOoKxdDqZ5FVniFmuKVy7Oaz2Ecl3FLcvbfx7
          mqoI9F0lsuaSdIaDT87tcDgXDA91blyiSSbe+RPG/Hmlb7lQvXRIh5SwtwLoDcLP
          o9UFCNzO/SjoNLnntqt3bGpT6qRzMYKu3tkzByyQXPbUQ4dO9D2q+b3SYDpPRY0u
          Srme7HQA798LkSLHO0ENHXwW9BG1dL4SZOKnEwCk+j4egVRQLfLRIezRqcSzdCLL
          bLSs7L0ApDjwZLk8JtpH5NLSyy+wPm+55990/9vkNhCUIcdXOtl5OFlOh3XZKM3r
          9IlpTwM7qFFz7SgM9BcxI2HvSsMGLdwg0WLPjwIDAQABo1AwTjAdBgNVHQ4EFgQU
          vFN43MvmkOT6zINC/csATv9KLaMwHwYDVR0jBBgwFoAUvFN43MvmkOT6zINC/csA
          Tv9KLaMwDAYDVR0TBAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAKWAl0bd0+crl
          AidD8VSg+hxJcEZT3IKJ8PxlureUzPGxm+tk3k++g2To/skrW4KHcJ3HAgK6Bll7
          uPCbUphJfJKVUe37zJSKIbGrDUboSkTbab7p3fIpehq0NkfHKjkmOX35rtvaNOl9
          RupX9EsSwNUqReVMDC6cwQEIfFX+vStfN4TgAacM4OkSZ7iZxaRbHUYxSFtkyPJw
          U0yoCSwFJdBqa6OFJ2ZCdUvhSEO1ug8ERgd2cLx1GeIdIBKX4mZGW+pyRhI6qM5k
          6/WxI6TLp5gixicV8q+K6D642ioKXzbxMQWSLq9KmDIocjsnMybP1/7hwKUZxiEZ
          Q70T7pP0zQ==
          -----END CERTIFICATE-----
    - path: /opt/bin/habitus
      filesystem: root
      mode: 0755
      user:
        id: 0
      contents:
        remote:
          url: https://github.com/cloud66/habitus/releases/download/v0.4.7/habitus_linux_amd64
          verification:
            hash:
              function: 'sha512'
              sum: '9d7ed3f2312b3e8ae1c53bd6b73eb88c21f8f4b94b96c0b55823fb25906a757899b116f872cd1b29dba824621be25e88616c31f4723b255abb1824c2f8d0e3e8'
    - path: /opt/bin/docker-compose
      filesystem: root
      mode: 0755
      user:
        id: 0
      contents:
        remote:
          url: https://github.com/docker/compose/releases/download/1.8.0/docker-compose-Linux-x86_64
          verification:
            hash:
              function: 'sha512'
              sum: 'b608b8c20d30e344797a5e5ab06e4ba4f3358a84b039924b09757cc04a96352d3cf0f360c239925ac5144bf9017c81c19f4ebe100bb75824698fc16b335cd9db'
    - path: /opt/vault.zip
      filesystem: root
      mode: 0644
      user:
        id: 0
      contents:
        remote:
          url: https://releases.hashicorp.com/vault/0.6.2/vault_0.6.2_linux_amd64.zip
          verification:
            hash:
              function: 'sha512'
              sum: '5a37ad553d38849a5a91568ce03d23abf668850049b3d550a5309a1acc391347156d09e08c8115599654c19a7c67856aa6776ac939a34440a095eb35cc47de37'
