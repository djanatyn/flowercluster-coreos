---
systemd:
  units:
    - name: etcd2.service
      enable: True
      dropins:
        - name: metadata.conf
          contents: |
            [Unit]
            Requires=coreos-metadata.service
            After=coreos-metadata.service
            [Service]
            EnvironmentFile=/run/metadata/coreos
            ExecStart=
            ExecStart=/usr/bin/etcd2 \
            --advertise-client-urls=http://${COREOS_GCE_IP_EXTERNAL_0}:2379 \
            --initial-advertise-peer-urls=http://${COREOS_GCE_IP_EXTERNAL_0}:2380 \
            --listen-client-urls=http://0.0.0.0:2379 \
            --listen-peer-urls=http://${COREOS_GCE_IP_EXTERNAL_0}:2380 \
            --discovery=https://discovery.etcd.io/6254d174b0ca958abd15d35b98a9fd60
    - name: var-lib-docker.mount
      enable: True
      contents: |
        [Unit]
        Description=mount persistent drive to /var/lib/docker
        [Mount]
        What=/dev/disk/by-id/google-stable-docker
        Where=/var/lib/docker
        Type=ext4
    - name: docker.service
      enable: True
      dropins:
        - name: 10-wait-docker.conf
          contents: |
            [Unit]
            After=var-lib-docker.mount
            Requires=var-lib-docker.mount
    - name: registry.service
      enable: True
      contents: |
        [Unit]
        Description=Registry
        After=docker.service

        [Service]
        RestartSec=10s
        Restart=on-failure
        ExecStartPre=-/usr/bin/docker kill registry1
        ExecStartPre=-/usr/bin/docker rm registry1
        ExecStart=/usr/bin/docker run -p 5000:5000 -v registry-data:/var/lib/registry -v registry-certs:/certs -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key --name registry1 registry:2
        ExecStop=/usr/bin/docker stop -t 2 registry1
    - name: gogs.service
      enable: True
      contents: |
        [Unit]
        Description=gogs
        After=docker.service

        [Service]
        RestartSec=10s
        Restart=on-failure
        ExecStartPre=-/usr/bin/docker kill gogs1
        ExecStartPre=-/usr/bin/docker rm gogs1
        ExecStart=/usr/bin/docker run --name gogs1 -p 3000:3000 -p 3001:22 -v gogs-data:/data stable:5000/flowercluster-gogs
        ExecStop=/usr/bin/docker stop -t 2 gogs
    - name: development.service
      enable: True
      contents: |
        [Unit]
        After=docker.service

        [Service]
        RestartSec=10s
        Restart=on-failure
        ExecStartPre=-/usr/bin/docker kill development1
        ExecStartPre=-/usr/bin/docker rm development1
        ExecStart=/usr/bin/docker run --name development1 -v home-data:/home -p 2222:22 stable:5000/development
        ExecStop=/usr/bin/docker stop -t 2 development1
storage:
  files:
    - path: /etc/docker/certs.d/stable:5000/domain.crt
      filesystem: root
      mode: 0644
      user:
        id: 0
      contents:
        inline: |
          -----BEGIN CERTIFICATE-----
          MIIC9TCCAd2gAwIBAgIJAMxqwLP3h2pQMA0GCSqGSIb3DQEBCwUAMBExDzANBgNV
          BAMMBnN0YWJsZTAeFw0xNjA4MjQxNzUyMjJaFw0xNzA4MjQxNzUyMjJaMBExDzAN
          BgNVBAMMBnN0YWJsZTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMTU
          Ir19HetCT5C+uX+qJnw3InBIMk05uJJTeBWWVBTvvVKmEtrwtRtGts0ue4dYQhpm
          72gy3zerg8/GQM3QGuNfkVtdtcNhp7kHFT7sAjv+C2/ZnEl0oBkT2VoRCePT6ydu
          kMXVMaA7lpZAIcKkZ13aiCG2cMrlpAg6Lo44Dy+vJCBoY2LnJkrgV2FpIIPLFdQ6
          OVEkLKDWQNfIVv5ljwP5PDKs38IdYfQpnmGnd7pOp8Aao18FyiR+rST0wlKNY+Fv
          egANIwQrYJwYBQDKuASaxGHSF4DXrJidHUCcbkS2xAl5ohHM3lAl+Lu4/iq6BZLf
          sftkP87U/9qMTVud35sCAwEAAaNQME4wHQYDVR0OBBYEFJxKekgur5Jjwh00BgWq
          blLyBNfNMB8GA1UdIwQYMBaAFJxKekgur5Jjwh00BgWqblLyBNfNMAwGA1UdEwQF
          MAMBAf8wDQYJKoZIhvcNAQELBQADggEBAHSRLCMmHMK4SyqPweleaq5/FRcE2aqs
          3Tmk7YWNRAC8V2Dly3oQrp0YBcr+T9AiXcMJVaPBwPTzIpfA6hsMgj2HVmzHk4xi
          615tuGjufGQlEsYy1sUQsgUNWBk8bLTZsM4ZVEKPxnDzp5aZKV7jlFLlWhnlwS+C
          mtaP0b9blrl3qE1XPts/eKlivtlzWGpnfbWGZngKqVj9UmdmgZH0C3y6UqeQjLAG
          IBXI6Kf7uuUMtAGZnQH8rKs66ecpIXHLegZ9Xg3N1cgRpU62BraTqrhATWGoy8F5
          rdkh7KPIcGQwoySbmVEhHJxiXN9TdQkxq5hEPlUbqmspWO/oRT/sMuk=
          -----END CERTIFICATE-----
  filesystems:
    - mount:
        device: '/dev/disk/by-id/google-stable-docker'
        format: 'ext4'
        create:
          force: false
